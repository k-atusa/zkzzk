<!DOCTYPE html>
<html lang="ko">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ZKZZK - 다시보기 다운로드</title>
	<link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
	<link rel="icon" type="image/x-icon" href="/static/favicon.svg">
	<link rel="icon" type="image/png" href="/static/favicon.svg">
	<link rel="stylesheet" href="/static/common.css">
	<link rel="stylesheet" href="/static/navbar.css">
	<link rel="stylesheet" href="/static/vod.css">
	<script src="https://cdn.tailwindcss.com"></script>
	<script>
		tailwind.config = {
			theme: {
				extend: {
					colors: {
						'accent': 'rgb(113, 243, 166)',
						'accent-dark': 'rgb(89, 194, 133)',
						'accent-light': 'rgb(137, 255, 179)',
					}
				}
			}
		}
	</script>
	<script src="https://unpkg.com/heroicons@2.0.18/24/outline/index.js"></script>
</head>

<body>
	{% include 'navbar.html' %}



	<div class="pt-28 pb-8 px-6">
		<div class="max-w-4xl mx-auto">
			<div class="mb-8">
				<h2 class="text-2xl font-bold text-white mb-2">다시보기 다운로드</h2>
			</div>

			<form id="vodInfoForm" class="mb-8">
				<div class="mb-4">
					<label for="vodUrl" class="block text-lg font-semibold text-white mb-4">치지직 다시보기 URL</label>
					<div class="flex gap-4">
						<input type="url" class="form-input h-12 flex-1" id="vodUrl"
							placeholder="https://chzzk.naver.com/video/..." required
							pattern="https?://chzzk\.naver\.com/video/.*">
						<button type="submit" class="btn-primary h-12 px-6" id="getInfoBtn">
							검색
						</button>
					</div>
					<p class="text-muted text-sm mt-1">치지직 다시보기 URL을 입력하면 영상 정보와 다운로드 링크를 제공합니다.</p>
				</div>
			</form>

			<div id="vodInfo" class="hidden">
				<div class="download-card p-6 mb-4">
					<div class="flex justify-between items-start mb-4">
						<div class="flex-1">
							<h3 class="text-lg font-semibold text-white mb-2" id="videoTitle">영상 제목</h3>
							<div class="text-sm text-muted space-y-1">
								<p id="videoAuthor"></p>
								<p id="videoPublishDate" class="hidden">
									<svg class="w-3 h-3 inline mr-1 flex-shrink-0" fill="none" stroke="currentColor"
										viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
											d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
										</path>
									</svg>
									<span class="publish-date-text"></span>
								</p>
								<div class="flex flex-wrap gap-1">
									<div id="videoCategory" class="hidden">
										<span class="bg-accent bg-opacity-20 text-accent text-xs px-2 py-1 rounded-full"
											id="categoryTag"></span>
									</div>
									<div id="videoTags" class="hidden">
										<div class="flex flex-wrap gap-1" id="tagsContainer"></div>
									</div>
								</div>
							</div>
						</div>
					</div>


					<div class="mb-4">
						<h4 class="text-md font-semibold text-white mb-3">화질 선택</h4>
						<div id="resolutionOptions" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
						</div>
					</div>


					<div id="selectedQualityInfo" class="hidden mb-4">
						<div class="flex gap-2">
							<button id="downloadToDeviceBtn" class="btn-primary px-4 py-2 text-sm">
								<svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
										d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
									</path>
								</svg>
								기기에 다운로드
							</button>
							<button id="downloadToServerBtn"
								class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-xl text-sm transition-colors">
								<svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
										d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h6l2 2h6a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2">
									</path>
								</svg>
								서버에 다운로드
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>


	<script>
		document.getElementById('vodInfoForm').addEventListener('submit', async (e) => {
			e.preventDefault();
			const vodUrl = document.getElementById('vodUrl').value;
			const getInfoBtn = document.getElementById('getInfoBtn');
			const vodInfoDiv = document.getElementById('vodInfo');

			try {
				getInfoBtn.disabled = true;
				getInfoBtn.innerHTML = `
					<svg class="w-5 h-5 inline mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
					</svg>
					처리 중...
				`;

				const response = await fetch('/get_vod_info', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({ vod_url: vodUrl })
				});

				const data = await response.json();

				if (data.status === 'success') {

					document.getElementById('videoTitle').textContent = data.video_info.title;
					document.getElementById('videoAuthor').textContent = `${data.video_info.author}`;

					if (data.video_info.publish_date) {
						document.querySelector('#videoPublishDate .publish-date-text').textContent = `업로드: ${data.video_info.publish_date}`;
						document.getElementById('videoPublishDate').classList.remove('hidden');
					} else {
						document.getElementById('videoPublishDate').classList.add('hidden');
					}

					if (data.video_info.category) {
						document.getElementById('categoryTag').textContent = data.video_info.category;
						document.getElementById('videoCategory').classList.remove('hidden');
					} else {
						document.getElementById('videoCategory').classList.add('hidden');
					}

					if (data.video_info.tags && data.video_info.tags.length > 0) {
						const tagsContainer = document.getElementById('tagsContainer');
						tagsContainer.innerHTML = '';

						data.video_info.tags.forEach(tag => {
							const tagSpan = document.createElement('span');
							tagSpan.className = 'bg-white bg-opacity-10 text-white text-xs px-2 py-1 rounded-full';
							tagSpan.textContent = tag;
							tagsContainer.appendChild(tagSpan);
						});

						document.getElementById('videoTags').classList.remove('hidden');
					} else {
						document.getElementById('videoTags').classList.add('hidden');
					}

					createResolutionOptions(data.resolutions, data.video_info);

					vodInfoDiv.classList.remove('hidden');
				} else {
					alert(data.message);
				}
			} catch (error) {
				console.error('Error:', error);
				alert('VOD 정보 가져오기 중 오류가 발생했습니다.');
			} finally {
				getInfoBtn.disabled = false;
				getInfoBtn.innerHTML = `검색`;
			}
		});

		function createResolutionOptions(resolutions, videoInfo) {
			const container = document.getElementById('resolutionOptions');
			container.innerHTML = '';

			resolutions.forEach((resolution, index) => {
				const optionDiv = document.createElement('div');
				optionDiv.className = 'bg-gray-800 border border-gray-700 rounded-lg p-4 cursor-pointer transition-all hover:border-accent hover:bg-gray-700';
				optionDiv.dataset.resolution = resolution.resolution;
				optionDiv.dataset.downloadUrl = resolution.download_url;
				optionDiv.dataset.estimatedSize = resolution.estimated_size_mb;

				optionDiv.innerHTML = `
					<div class="flex justify-between items-center mb-2">
						<span class="text-white font-medium">${resolution.resolution}</span>
						<span class="text-accent text-sm">${resolution.quality}</span>
					</div>
					<div class="text-sm text-muted space-y-1">
						<p>비트레이트: ${(resolution.bandwidth / 1000).toFixed(0)} Kbps</p>
						<p>예상 크기: ${resolution.estimated_size_mb} MB</p>
					</div>
				`;

				optionDiv.addEventListener('click', () => {

					document.querySelectorAll('#resolutionOptions > div').forEach(div => {
						div.classList.remove('border-accent', 'bg-gray-700');
						div.classList.add('border-gray-700', 'bg-gray-800');
					});

					optionDiv.classList.remove('border-gray-700', 'bg-gray-800');
					optionDiv.classList.add('border-accent', 'bg-gray-700');

					showSelectedQuality(resolution, videoInfo);
				});

				container.appendChild(optionDiv);

				if (index === 0) {
					optionDiv.click();
				}
			});
		}

		let selectedResolution = null;
		let currentVideoInfo = null;

		function showSelectedQuality(resolution, videoInfo) {
			const selectedQualityInfo = document.getElementById('selectedQualityInfo');

			selectedResolution = resolution;
			currentVideoInfo = videoInfo;

			selectedQualityInfo.classList.remove('hidden');
		}

		function generateFilename(videoInfo, resolution) {
			const title = videoInfo.title || 'Unknown';
			const author = videoInfo.author || 'Unknown';
			const quality = resolution.quality || '720p';

			let datePrefix = '';
			if (videoInfo.publish_date) {
				try {
					const date = new Date(videoInfo.publish_date);
					const year = date.getFullYear().toString().slice(-2);
					const month = (date.getMonth() + 1).toString().padStart(2, '0');
					const day = date.getDate().toString().padStart(2, '0');
					datePrefix = `${year}${month}${day}`;
				} catch (e) {
					console.error('Error parsing date:', e);
					datePrefix = new Date().toISOString().slice(2, 8).replace(/-/g, '');
				}
			} else {
				const now = new Date();
				const year = now.getFullYear().toString().slice(-2);
				const month = (now.getMonth() + 1).toString().padStart(2, '0');
				const day = now.getDate().toString().padStart(2, '0');
				datePrefix = `${year}${month}${day}`;
			}

			const cleanTitle = title.replace(/[<>:"/\\|?*]/g, '').trim();
			const cleanAuthor = author.replace(/[<>:"/\\|?*]/g, '').trim();

			return `${datePrefix} ${cleanTitle} [${cleanAuthor}].mp4`;
		}

		document.getElementById('downloadToDeviceBtn').addEventListener('click', () => {
			if (!selectedResolution || !currentVideoInfo) {
				alert('다운로드할 영상을 선택해주세요.');
				return;
			}

			const filename = generateFilename(currentVideoInfo, selectedResolution);
			const downloadUrl = selectedResolution.download_url;

			const link = document.createElement('a');
			link.href = downloadUrl;
			link.download = filename;
			link.target = '_blank';
			document.body.appendChild(link);
			link.click();
			document.body.removeChild(link);
		});

		document.getElementById('downloadToServerBtn').addEventListener('click', async () => {
			if (!selectedResolution || !currentVideoInfo) {
				alert('다운로드할 영상을 선택해주세요.');
				return;
			}

			const filename = generateFilename(currentVideoInfo, selectedResolution);
			const downloadUrl = selectedResolution.download_url;

			try {
				const response = await fetch('/download_vod', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({
						download_url: downloadUrl,
						filename: filename,
						video_info: currentVideoInfo,
						resolution: selectedResolution
					})
				});

				const data = await response.json();

				if (data.status === 'success') {
					alert('서버에 다운로드가 시작되었습니다.');
				} else {
					alert(data.message || '서버 다운로드 중 오류가 발생했습니다.');
				}
			} catch (error) {
				console.error('Error downloading to server:', error);
				alert('서버 다운로드 중 오류가 발생했습니다.');
			}
		});


	</script>
</body>

</html>