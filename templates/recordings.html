<!DOCTYPE html>
<html lang="ko">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ZKZZK - 녹화 영상</title>
	<link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
	<link rel="icon" type="image/x-icon" href="/static/favicon.ico">
	<link rel="icon" type="image/png" href="/static/favicon.png">
	<link rel="stylesheet" href="/static/common.css">
	<link rel="stylesheet" href="/static/navbar.css">
	<link rel="stylesheet" href="/static/recordings.css">
	<script src="https://cdn.tailwindcss.com"></script>
	<script>
		tailwind.config = {
			theme: {
				extend: {
					colors: {
						'accent': 'rgb(113, 243, 166)',
						'accent-dark': 'rgb(89, 194, 133)',
						'accent-light': 'rgb(137, 255, 179)',
					}
				}
			}
		}
	</script>
	<script src="https://unpkg.com/heroicons@2.0.18/24/outline/index.js"></script>
</head>

<body>
	<!-- Navigation Bar -->
	{% include 'navbar.html' %}



	<div class="pt-20 pb-8 px-6">
		<div class="max-w-7xl mx-auto">
			{% for streamer_name, recordings in streamer_recordings.items() %}
			<div class="mb-8">
				<div class="streamer-header p-6 mb-6">
					<h2 class="text-2xl font-bold text-white">{{ streamer_name }}</h2>
				</div>
				<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
					{% for recording in recordings %}
					<div class="recording-card p-6">
						<h3 class="text-lg font-semibold text-white mb-3 truncate">{{ recording.title }}</h3>
						<p class="text-muted text-sm mb-4">
							<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
									d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
							</svg>
							{{ recording.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
						</p>
						<div class="video-container mb-4">
							<div class="video-thumbnail" data-filename="{{ recording.filename }}">
								<div class="play-button">
									<svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
											d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.347a1.125 1.125 0 0 1 0 1.972l-11.54 6.347c-.75.412-1.667-.13-1.667-.986V5.653Z">
										</path>
									</svg>
								</div>
							</div>
							<video class="video-player hidden" controls data-filename="{{ recording.filename }}">
								<source src="/recordings/{{ recording.filename }}" type="video/mp4">
								Your browser does not support the video tag.
							</video>
						</div>
						<div class="flex justify-between items-center">
							<a href="/recordings/{{ recording.filename }}" class="btn-primary px-4 py-2" download>
								다운로드
							</a>
							<button class="btn-danger p-2 delete-recording" data-filename="{{ recording.filename }}">
								<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
										d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
									</path>
								</svg>
							</button>
						</div>
					</div>
					{% endfor %}
				</div>
			</div>
			{% endfor %}
		</div>
	</div>

	<!-- Custom JavaScript -->
	<script>
		document.getElementById('mobile-menu-btn').addEventListener('click', function () {
			document.getElementById('mobile-menu').classList.toggle('hidden');
		});

		function openSettings() {
			document.getElementById('settingsModal').classList.remove('hidden');
			loadSettings();
		}

		function closeSettings() {
			document.getElementById('settingsModal').classList.add('hidden');
		}

		async function saveSettings() {
			const nidAut = document.getElementById('nidAut').value;
			const nidSes = document.getElementById('nidSes').value;
			const accessPassword = document.getElementById('accessPassword').value;
			try {
				const response = await fetch('/settings', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ nid_aut: nidAut, nid_ses: nidSes, access_password: accessPassword })
				});
				const data = await response.json();
				if (data.status === 'success') {
					alert('설정이 저장되었습니다.');
					closeSettings();
				}
			} catch (e) {
				console.error(e);
				alert('설정 저장 중 오류가 발생했습니다.');
			}
		}

		async function loadSettings() {
			try {
				const res = await fetch('/settings');
				const data = await res.json();
				document.getElementById('nidAut').value = data.nid_aut || '';
				document.getElementById('nidSes').value = data.nid_ses || '';
				const pwInput = document.getElementById('accessPassword');
				pwInput.value = '';
				pwInput.placeholder = data.access_password_set ? '설정됨 (변경하려면 새 비밀번호 입력)' : '비밀번호를 입력하세요 (비우면 해제)';
				const logoutBtn = document.getElementById('logoutButton');
				if (logoutBtn) {
					if (data.access_password_set) logoutBtn.classList.remove('hidden');
					else logoutBtn.classList.add('hidden');
				}
			} catch (e) {
				console.error(e);
			}
		}

		async function logoutSession() {
			try { await fetch('/logout', { method: 'POST' }); } catch (e) {}
			window.location.href = '/login';
		}

		document.querySelectorAll('.delete-recording').forEach(button => {
			button.addEventListener('click', async (e) => {
				if (confirm('정말로 이 녹화 영상을 삭제하시겠습니까?')) {
					const filename = e.target.closest('.delete-recording').dataset.filename;
					try {
						const response = await fetch(`/delete_recording/${filename}`, {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json'
							}
						});
						const data = await response.json();

						if (data.status === 'success') {
							const card = e.target.closest('.recording-card');
							const streamerSection = card.closest('.mb-8');
							card.remove();

							const remainingCards = streamerSection.querySelectorAll('.recording-card');
							if (remainingCards.length === 0) {
								streamerSection.remove();
							}
						} else {
							alert(data.message);
						}
					} catch (error) {
						console.error('Error:', error);
						alert('녹화 영상 삭제 중 오류가 발생했습니다.');
					}
				}
			});
		});

		document.querySelectorAll('.video-thumbnail').forEach(thumbnail => {
			thumbnail.addEventListener('click', function () {
				const filename = this.dataset.filename;
				const video = document.querySelector(`video[data-filename="${filename}"]`);
				const thumbnailContainer = this.closest('.video-container');

				document.querySelectorAll('.video-player').forEach(v => v.classList.add('hidden'));
				document.querySelectorAll('.video-thumbnail').forEach(t => t.classList.remove('hidden'));

				video.classList.remove('hidden');
				this.classList.add('hidden');
			});
		});
	</script>
</body>

</html>