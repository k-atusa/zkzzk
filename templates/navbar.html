<link rel="stylesheet" href="/static/navbar.css">


<nav class="navbar fixed top-0 w-full z-50 px-6 py-4">
	<div class="max-w-7xl mx-auto flex justify-between items-center">
		<a href="/" class="text-xl font-bold text-white">ZKZZK</a>
		<div class="hidden md:flex items-center space-x-4">
			<div class="flex space-x-6">
				<a href="/live"
					class="{% if current_page == 'live' %}text-accent font-medium{% else %}text-white hover:text-accent transition-colors{% endif %}">라이브
					녹화</a>
				<a href="/recordings"
					class="{% if current_page == 'recordings' %}text-accent font-medium{% else %}text-white hover:text-accent transition-colors{% endif %}">녹화
					영상</a>
				<a href="/vod"
					class="{% if current_page == 'vod' %}text-accent font-medium{% else %}text-white hover:text-accent transition-colors{% endif %}">다시보기
					다운로드</a>
			</div>
			<div class="relative" id="profileMenuWrapper">
				<button class="btn-secondary px-3 py-2" type="button" onclick="toggleProfileMenu()">
					<svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A3 3 0 017 17h10a3 3 0 011.879.804L21 20H3l2.121-2.196zM15 11a3 3 0 10-6 0 3 3 0 006 0z"></path>
					</svg>
					{{ current_user.username if current_user else '로그인' }}
				</button>
				<div id="profileMenu" class="absolute right-0 mt-2 w-48 rounded-md bg-gray-900 border border-white/10 shadow-lg hidden">
					<a href="#" class="block px-4 py-2 text-white hover:text-accent" onclick="openSettings()">설정</a>
					<a href="/profile" class="block px-4 py-2 text-white hover:text-accent">프로필</a>
					{% if current_user and current_user.is_admin %}
					<a href="/admin/users" class="block px-4 py-2 text-white hover:text-accent">관리자 페이지</a>
					{% endif %}
					<form method="POST" action="/logout">
						<button type="submit" class="w-full text-left px-4 py-2 text-white hover:text-accent">로그아웃</button>
					</form>
				</div>
			</div>
		</div>
		<button class="md:hidden text-white" id="mobile-menu-btn">
			<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16">
				</path>
			</svg>
		</button>
	</div>

	<div class="md:hidden hidden" id="mobile-menu">
		<div class="px-2 pt-2 pb-3 space-y-1">
			<a href="/live"
				class="block px-3 py-2 {% if current_page == 'live' %}text-accent font-medium{% else %}text-white hover:text-accent transition-colors{% endif %}">라이브
				녹화</a>
			<a href="/recordings"
				class="block px-3 py-2 {% if current_page == 'recordings' %}text-accent font-medium{% else %}text-white hover:text-accent transition-colors{% endif %}">녹화
				영상</a>
			<a href="/vod"
				class="block px-3 py-2 {% if current_page == 'vod' %}text-accent font-medium{% else %}text-white hover:text-accent transition-colors{% endif %}">다시보기
				다운로드</a>
			<div class="border-t border-white/10 my-2"></div>
			<a href="#" class="block px-3 py-2 text-white hover:text-accent" onclick="openSettings()">설정</a>
			<a href="/profile" class="block px-3 py-2 text-white hover:text-accent">프로필</a>
			{% if current_user and current_user.is_admin %}
			<a href="/admin/users" class="block px-3 py-2 text-white hover:text-accent">관리자 페이지</a>
			{% endif %}
			<form method="POST" action="/logout" class="px-3 py-2">
				<button type="submit" class="text-white hover:text-accent">로그아웃</button>
			</form>
		</div>
	</div>
</nav>


<div id="settingsModal" class="modal fixed inset-0 z-50 hidden">
	<div class="flex items-center justify-center min-h-screen p-4">
		<div class="modal-content w-full max-w-md p-6">
			<div class="flex justify-between items-center mb-4">
				<h3 class="text-lg font-semibold text-white">설정</h3>
				<button onclick="closeSettings()" class="text-white hover:text-accent">
					<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
						</path>
					</svg>
				</button>
			</div>
			<form id="settingsForm">
				<div class="mb-4">
					<label for="nidAut" class="block text-sm font-medium text-white mb-2">NID_AUT</label>
					<input type="text" class="form-input" id="nidAut" placeholder="NID_AUT 값을 입력하세요">
				</div>
				<div class="mb-6">
					<label for="nidSes" class="block text-sm font-medium text-white mb-2">NID_SES</label>
					<input type="text" class="form-input" id="nidSes" placeholder="NID_SES 값을 입력하세요">
				</div>
				<div class="mb-6">
					<label for="accessPassword" class="block text-sm font-medium text-white mb-2">페이지 비밀번호</label>
					<input type="password" class="form-input" id="accessPassword" placeholder="비밀번호를 입력하세요 (비우면 해제)">
					<p class="text-muted text-xs mt-1">비워두면 보호가 해제됩니다.</p>
				</div>
				<div class="flex justify-end items-center">
					<button type="button" id="logoutButton" class="btn-danger px-4 py-2 mr-auto hidden"
						onclick="logoutSession()">로그아웃</button>
					<div class="space-x-3">
						<button type="button" class="btn-secondary px-4 py-2" onclick="closeSettings()">닫기</button>
						<button type="button" class="btn-primary px-4 py-2" onclick="saveSettings()">저장</button>
					</div>
				</div>
			</form>
		</div>
	</div>
</div>


<script>
	// Global variables for live page functionality
	let isCheckingEnabled = true;

	// Mobile menu toggle
	document.getElementById('mobile-menu-btn').addEventListener('click', function () {
		document.getElementById('mobile-menu').classList.toggle('hidden');
	});

	function toggleProfileMenu() {
		const el = document.getElementById('profileMenu');
		if (el) el.classList.toggle('hidden');
	}

	// Settings modal functions
	function openSettings() {
		document.getElementById('settingsModal').classList.remove('hidden');
		loadSettings();
	}

	function closeSettings() {
		document.getElementById('settingsModal').classList.add('hidden');
	}

	// 설정 저장
	async function saveSettings() {
		const nidAut = document.getElementById('nidAut').value;
		const nidSes = document.getElementById('nidSes').value;
		const accessPassword = document.getElementById('accessPassword').value;

		try {
			const response = await fetch('/settings', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ nid_aut: nidAut, nid_ses: nidSes, access_password: accessPassword })
			});
			const data = await response.json();

			if (data.status === 'success') {
				alert('설정이 저장되었습니다.');
				closeSettings();

				// 설정 저장 후 스트리머 상태 확인 재시작 (live 페이지에서만)
				if (typeof checkStreamerStatus === 'function' && typeof statusCheckInterval !== 'undefined') {
					if (!isCheckingEnabled) {
						isCheckingEnabled = true;
						checkStreamerStatus();
						statusCheckInterval = setInterval(checkStreamerStatus, 30000);
					}
				}
			} else {
				alert(data.message);
			}
		} catch (error) {
			console.error('Error:', error);
			alert('설정 저장 중 오류가 발생했습니다.');
		}
	}

	async function logoutSession() {
		try {
			await fetch('/logout', { method: 'POST' });
		} catch (e) { }
		window.location.href = '/login';
	}

	// 설정 로드
	async function loadSettings() {
		try {
			const response = await fetch('/settings');
			const data = await response.json();

			document.getElementById('nidAut').value = data.nid_aut;
			document.getElementById('nidSes').value = data.nid_ses;
			const pwInput = document.getElementById('accessPassword');
			pwInput.value = '';
			pwInput.placeholder = data.access_password_set ? '설정됨 (변경하려면 새 비밀번호 입력)' : '비밀번호를 입력하세요 (비우면 해제)';
			const logoutBtn = document.getElementById('logoutButton');
			if (logoutBtn) {
				if (data.access_password_set) logoutBtn.classList.remove('hidden');
				else logoutBtn.classList.add('hidden');
			}
		} catch (error) {
			console.error('Error:', error);
		}
	}
</script>